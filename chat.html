<!doctype html>
<html lang="en">
  <head>
   
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="./styles/chatStyle.css">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link href="./styles/my_style.css" rel="stylesheet">

    <title>Hello, world!</title>

    <!-- Firebase 8 CDNs-->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous">
  </script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/ui/4.8.1/firebase-ui-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
  <!-- Link to the api keys for your firebase project -->
  <script src="./scripts/firebaseAPI.js"></script>
    
  </head>
  <body>

    <!-- Top Navbar -->
    <nav class="navbar fixed-top navbar-expand-lg navbar-light bg-info">
        <div class="container-fluid">
          <a class="navbar-brand" href="main.html">Ryme</a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
              <!-- Got rid of the bottom nav and put it here, I linked main.html to Ryme-->
              <li>
                <a class="bottomNavButton" aria-current="page" href="userprofile.html"><img class="bottomNavImg" src="/images/account-circle-line.png"></a>
              </li>
              <li>
                <a class="bottomNavButton" aria-current="page" href="chat.html"><img class="bottomNavImg" src="/images/chat-1-line.png"></a>
              </li>
            </ul>
            <form class="d-flex">
              <button id="filterbutton"><img id="filterimg" src="/images/filtericon.png"></button>
              <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search">
              <button class="btn btn-outline-success" type="submit">Search</button>
            </form>
          </div>
        </div>
      </nav>

  <!-- Overlay for search filters -->
  <div id="filterOverlay">
    <br>
    <h1>Search Filters</h1>
    <button id="filterclosebutton" class="btn btn-secondary">Close</button>
    <br>
    <div id="skill">
        <h2>Skill Level</h2>
        <div class="btn-group" role="group" aria-label="Basic checkbox toggle button group">
            <input type="checkbox" class="btn-check" id="btncheck1" autocomplete="off" checked>
            <label class="btn btn-outline-primary" for="btncheck1">Casual</label>
          
            <input type="checkbox" class="btn-check" id="btncheck2" autocomplete="off" checked>
            <label class="btn btn-outline-primary" for="btncheck2">Medium</label>
          
            <input type="checkbox" class="btn-check" id="btncheck3" autocomplete="off" checked>
            <label class="btn btn-outline-primary" for="btncheck3">Hardcore</label>
        </div>
    </div>

    <br>

    <div id="genre">
        <h2>Favourite Genre</h2>
        <div class="form-check">
            <input class="form-check-input" type="checkbox" value="" id="filtermoba" checked>
            <label class="form-check-label" for="flexCheckDefault">
              MOBA
            </label>
        </div>
        <div class="form-check">
            <input class="form-check-input" type="checkbox" value="" id="filterbattleroyale" checked>
            <label class="form-check-label" for="flexCheckDefault">
              Battle Royale
            </label>
        </div>
        <div class="form-check">
            <input class="form-check-input" type="checkbox" value="" id="filterrts" checked>
            <label class="form-check-label" for="flexCheckDefault">
              RTS
            </label>
        </div>
        <div class="form-check">
            <input class="form-check-input" type="checkbox" value="" id="filtershooter" checked>
            <label class="form-check-label" for="flexCheckDefault">
              Shooter
            </label>
        </div>
        <div class="form-check">
            <input class="form-check-input" type="checkbox" value="" id="filtermmo" checked>
            <label class="form-check-label" for="flexCheckDefault">
              MMORPG
            </label>
        </div>
        <div class="form-check">
            <input class="form-check-input" type="checkbox" value="" id="filterstory" checked>
            <label class="form-check-label" for="flexCheckDefault">
              Story
            </label>
        </div>
    </div>

    <br>

    <div id="rating">
      <h2>User Ratings</h2>
      <div class="btn-group" role="group" aria-label="Basic checkbox toggle button group">
        <input type="checkbox" class="btn-check" id="btncheck4" autocomplete="off" checked>
        <label class="btn btn-outline-primary" for="btncheck4">1 star</label>
      
        <input type="checkbox" class="btn-check" id="btncheck5" autocomplete="off" checked>
        <label class="btn btn-outline-primary" for="btncheck5">2 stars</label>
      
        <input type="checkbox" class="btn-check" id="btncheck6" autocomplete="off" checked>
        <label class="btn btn-outline-primary" for="btncheck6">3 stars</label>

        <input type="checkbox" class="btn-check" id="btncheck7" autocomplete="off" checked>
        <label class="btn btn-outline-primary" for="btncheck7">4 stars</label>

        <input type="checkbox" class="btn-check" id="btncheck8" autocomplete="off" checked>
        <label class="btn btn-outline-primary" for="btncheck8">5 stars</label>
      </div>

    </div>

    <br>

    <div id="availability">
      <h2>Availability</h2>
      <label for="customRange3" class="form-label">0 hours  </label>
      <input type="range" class="form-range" min="0" max="5" step="0.5" id="customRange3" style="width: 50%;">  
      <label for="customRange3" class="form-label">30+ hours</label>
    </div>
  </div>

  <!-- Bottom Navbar -->
  <nav class="navbar fixed-bottom navbar-expand-sm navbar-dark bg-dark" id="bottomNavBar">
    <div class="bottomNavDiv">
      <a id="bottomHomeButton" class="bottomNavButton" aria-current="page" href="main.html"><img class="bottomNavImg"
          src="/images/home-2-line.png"></a>
    </div>
    <div class="bottomNavDiv">
      <a id="bottomChatButton" class="bottomNavButton" aria-current="page" href="chat.html"><img class="bottomNavImg"
          src="/images/chat-1-line.png"></a>
    </div>
    <div class="bottomNavDiv">
      <a id="bottomProfileButton" class="bottomNavButton" aria-current="page" href="userprofile.html"><img class="bottomNavImg"
          src="/images/account-circle-line.png"></a>
    </div>
  </nav>
  
<template id="card-template">
    <div class="card"></div>
    <div class="container msg">
        <b class="card-name"> Name</b>
        <span class="card-body"> some stuff </span>
    </div>
</template>

<div class="container py-3">
    <h3>My Chat with <span id="friend">Friend</span></h3>
    <!--The div element for the map -->
    <!-- <input class="btn btn-success" value="Chat Samsantech" onclick="chat('samsantech')"> -->

    <!-- <input id="username" type="text" placeholder="Enter name"><br/> -->
    <div class="container">
        <!-- <input id="text" type="text" placeholder="Enter name"><br /> -->

        <input id="text" type="text" placeholder="Enter message"><br />
        <button id="post"> Post </button> <br />
        <button id="quit"> Quit </button> <br />
        <div class="p-5 mb-4 bg-light rounded-3" id="results"></div>
    </div>
</div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script>
        function initChat() {
            //get the ID of who we are chatting with
            let params = new URL(window.location.href);
            let uid = params.searchParams.get("uid"); //parse "uid"
            let name = params.searchParams.get("name"); //parse "name"

            //set the title to show that person's name
            document.getElementById("friend").innerHTML = name;

            // generate a random 4 digit ID
            chatid = Math.random().toString().substr(2, 4);
            console.log(chatid);
            db.collection("chats").doc(chatid).set({
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).then(doc => {
                alert("Your Chat ID is " + chatid + ". Pass this to your friend.");
                postMessageListen(chatid);
                listenNewMessage(chatid);
                quitButtonListen(chatid);
            })  
        }
        initChat();

        function postMessageListen(chatid) {
            var textInput = document.getElementById("text");
            var postButton = document.getElementById("post");
            postButton.addEventListener("click", function () {
                var msgText = textInput.value; //user provided message
                firebase.auth().onAuthStateChanged(function (user) {
                    db.collection('chats').doc(chatid).collection("messages")
                        .add({
                            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                            name: user.displayName,
                            text: msgText
                        })
                    textInput.value = "";
                })
            });
        }

        function quitButtonListen(chatid) {
            var quitButton = document.getElementById("quit");
            quitButton.addEventListener("click", function () {
                db.collection("chats").doc(chatid)
                    .get()
                    .then(snap => {
                        snap.ref.delete();
                        window.location.href = "friends.html";
                    })

            })
        }

        function listenNewMessage(chatid) {
            db.collection("chats").doc(chatid).collection("messages")
                .onSnapshot(snap => {
                    snap.docChanges().forEach(change => {
                        if (change.type == "added") {
                            console.log("new message ", change.doc.data());
                            let msgCard = document.getElementById("card-template")
                                .content.cloneNode(true);
                            msgCard.querySelector('.card-body').innerHTML = change.doc.data().text;
                            msgCard.querySelector('.card-name').innerHTML = change.doc.data().name;
                            document.getElementById("results").appendChild(msgCard);
                        }
                    })
                })
        }
    </script>
  </body>
</html>