<!doctype html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

  <link rel="stylesheet" href="./styles/editprofileStyle.css">
  <link href="./styles/my_style.css" rel="stylesheet">

  <title>Edit Profile</title>

  <!-- Bootstrap FirebaseUI CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
  <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/4.8.1/firebase-ui-auth.css" />


  <!-- Firebase 8 CDNs-->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous">
    </script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/ui/4.8.1/firebase-ui-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

  <!-- Link to the api keys for your firebase project -->
  <script src="./scripts/firebaseAPI.js"></script>

</head>

<body>

  <!-- Top Navbar -->
  <nav class="navbar sticky-top navbar-expand-lg navbar-light bg-info">
    <nav class="navbar sticky-top navbar-expand-lg navbar-light bg-info">
      <div class="container-fluid">
        <a class="navbar-brand" href="main.html">Ryme</a>
        <!-- <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
          aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button> -->
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <!-- Got rid of the bottom nav and put it here, I linked main.html to Ryme-->
            <li>
              <a id="topProfileButton" class="NavButton" aria-current="page" href="userprofile.html"><img class="bottomNavImg"
                  src="/images/account-circle-line.png"></a>
            </li>
            <li>
              <a id="topChatButton" class="NavButton" aria-current="page" href="chat.html"><img class="bottomNavImg"
                  src="/images/chat-1-line.png"></a>
            </li>
          </ul>
          <form class="d-flex">
            <button id="filterbutton"><img id="filterimg" src="/images/filtericon.png"></button>
          </form>
        </div>
      </div>
    </nav>
  </nav>

  <!-- Overlay for search filters -->
  <div id="filterOverlay">
    <br>
    <h1>Search Filters</h1>
    <button id="filterclosebutton" class="btn btn-secondary">Close</button>
    <br>
    <div id="skill">
      <h2>Skill Level</h2>
      <div class="btn-group" role="group" aria-label="Basic checkbox toggle button group">
        <input type="checkbox" class="btn-check" id="btncheck1" autocomplete="off" checked>
        <label class="btn btn-outline-primary" for="btncheck1">Casual</label>

        <input type="checkbox" class="btn-check" id="btncheck2" autocomplete="off" checked>
        <label class="btn btn-outline-primary" for="btncheck2">Medium</label>

        <input type="checkbox" class="btn-check" id="btncheck3" autocomplete="off" checked>
        <label class="btn btn-outline-primary" for="btncheck3">Hardcore</label>
      </div>
    </div>

    <br>

    <div id="genre">
      <h2>Favourite Genre</h2>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" value="" id="filtermoba" checked>
        <label class="form-check-label" for="flexCheckDefault">
          MOBA
        </label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" value="" id="filterbattleroyale" checked>
        <label class="form-check-label" for="flexCheckDefault">
          Battle Royale
        </label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" value="" id="filterrts" checked>
        <label class="form-check-label" for="flexCheckDefault">
          RTS
        </label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" value="" id="filtershooter" checked>
        <label class="form-check-label" for="flexCheckDefault">
          Shooter
        </label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" value="" id="filtermmo" checked>
        <label class="form-check-label" for="flexCheckDefault">
          MMORPG
        </label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" value="" id="filterstory" checked>
        <label class="form-check-label" for="flexCheckDefault">
          Story
        </label>
      </div>
    </div>

    <br>

    <div id="rating">
      <h2>User Ratings</h2>
      <div class="btn-group" role="group" aria-label="Basic checkbox toggle button group">
        <input type="checkbox" class="btn-check" id="btncheck4" autocomplete="off" checked>
        <label class="btn btn-outline-primary" for="btncheck4">1 star</label>

        <input type="checkbox" class="btn-check" id="btncheck5" autocomplete="off" checked>
        <label class="btn btn-outline-primary" for="btncheck5">2 stars</label>

        <input type="checkbox" class="btn-check" id="btncheck6" autocomplete="off" checked>
        <label class="btn btn-outline-primary" for="btncheck6">3 stars</label>

        <input type="checkbox" class="btn-check" id="btncheck7" autocomplete="off" checked>
        <label class="btn btn-outline-primary" for="btncheck7">4 stars</label>

        <input type="checkbox" class="btn-check" id="btncheck8" autocomplete="off" checked>
        <label class="btn btn-outline-primary" for="btncheck8">5 stars</label>
      </div>

    </div>

    <br>

    <div id="availability">
      <h2>Availability</h2>
      <label for="customRange3" class="form-label">0 hours </label>
      <input type="range" class="form-range" min="0" max="5" step="0.5" id="customRange3" style="width: 50%;">
      <label for="customRange3" class="form-label">30+ hours</label>
    </div>
  </div>

  <!-- Bottom Navbar -->
  <!-- <nav class="navbar fixed-bottom navbar-expand-sm navbar-dark bg-dark" id="bottomNavBar">
    <div class="bottomNavDiv">
      <a class="bottomNavButton" aria-current="page" href="main.html"><img class="bottomNavImg"
          src="/images/home-2-line.png"></a>
    </div>
    <div class="bottomNavDiv">
      <a class="bottomNavButton" aria-current="page" href="chat.html"><img class="bottomNavImg"
          src="/images/chat-1-line.png"></a>
    </div>
    <div class="bottomNavDiv">
      <a class="bottomNavButton" aria-current="page" href="userprofile.html"><img class="bottomNavImg"
          src="/images/account-circle-line.png"></a>
    </div>
  </nav> -->

  <div class="container rounded bg-white mt-5 mb-5">
    <div class="row">
      <div class="col-md-3 border-right">
        <div class="d-flex flex-column align-items-center text-center p-3 py-5">
          <img class="rounded-circle mt-5" id="profilePic"
            src="images/placeholder.jpg" alt="image not here">
          <div class="container text-center py-3">
            <button type="button" class="btn btn-info" onclick="browseFile()">Edit</button>
            <input type="file" accept="image/*" id="uploadPic" />                  
          </div> 
        </div>
      </div>
      <div class="col-md-5 border-right">
        <form class="p-3 py-5">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="text-right">Profile Settings</h4>
          </div>
          <div class="row">
            <a href="games.html"><button type="button" class="btn btn-primary btn-md center-block">Add Games</button></a>
          </div>
          <div class="accordion mt-3" id="accordionExample">
            <div class="accordion-item">
              <h2 class="accordion-header" id="headingOne">
                <button class="accordion-button collapsed" type="button" id="changePref" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                  Change Preferences
                </button>
              </h2>
              <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#accordionExample">
                <div class="accordion-body">
                  <div class="container rounded bg-white">
                    <div class="row">
                       <div class="border-right">
                          <div class="pt-4 pb-5">
                              <div class="mb-4">
                                  <h3 class="mb-3">My Genres</h3>
                                  <div class="pt-1 ps-3">
                                    <div class="form-check">
                                      <input class="form-check-input" type="checkbox" value="" id="moba">
                                      <label class="form-check-label" for="moba">
                                        MOBA
                                      </label>
                                    </div>
                                    <div class="form-check">
                                      <input class="form-check-input" type="checkbox" value="" id="battleRoyale">
                                      <label class="form-check-label" for="battleRoyale">
                                        Battle Royale 
                                      </label>
                                    </div>
                                    <div class="form-check">
                                      <input class="form-check-input" type="checkbox" value="" id="rts">
                                      <label class="form-check-label" for="rts">
                                        RTS
                                      </label>
                                    </div>
                                    <div class="form-check">
                                      <input class="form-check-input" type="checkbox" value="" id="shooter">
                                      <label class="form-check-label" for="shooter">
                                        Shooter
                                      </label>
                                    </div>
                                    <div class="form-check">
                                      <input class="form-check-input" type="checkbox" value="" id="mmorpg">
                                      <label class="form-check-label" for="mmorpg">
                                        MMORPG
                                      </label>
                                    </div>
                                    <div class="form-check">
                                      <input class="form-check-input" type="checkbox" value="" id="story">
                                      <label class="form-check-label" for="story">
                                        Story
                                      </label>
                                    </div>
                                  </div>
                              </div>
              
                              <div class="mb-4">
                                <h3 class="mb-3">My Playstyle</h3>
                                <select class="form-select form-select-md mb-3" id="playstyle" aria-label=".form-select-lg example">
                                  <option value="casual">Casual</option>
                                  <option value="medium">Medium</option>
                                  <option value="hardcore">Hardcore</option>
                                </select>
                              </div>
                              
                              <div class="mb-5">
                                <h3 class="mb-3">My Gaming Schedule</h3>
                                <div class="pt-1 ps-3">
                                  <div class="form-check">
                                    <input class="form-check-input" type="radio" name="schedule" value="1" id="schedule1">
                                    <label class="form-check-label" for="schedule1">
                                      Daily
                                    </label>
                                  </div>
                                  <div class="form-check">
                                    <input class="form-check-input" type="radio" name="schedule" value="2" id="schedule2">
                                    <label class="form-check-label" for="schedule2">
                                      Weekend
                                    </label>
                                  </div>
                                  <div class="form-check">
                                    <input class="form-check-input" type="radio" name="schedule" value="3" id="schedule3">
                                    <label class="form-check-label" for="schedule3">
                                      Occasional
                                    </label>
                                  </div>
                                  <div class="form-check">
                                    <input class="form-check-input" type="radio" name="schedule" value="0" id="schedule4">
                                    <label class="form-check-label" for="schedule4">
                                      Other
                                    </label>
                                  </div>  
                                </div>
                            </div>
              
                            <div class="mt-3 ps-2 text-center d-grid gap-2 d-md-flex justify-content-start">
                              <a class="btn btn-info" id="savePref" type="button">Save</a>
                            </div>
                            </div>
                        </div>
                    </div>
                </div>
              
                </div>
              </div>
            </div>
          </div>
          
        
          <fieldset id="personalInfoFields" disabled>
            <div class="row mt-2">
              <div class="col-md-12">
                <label class="labels">Name</label>
                <input type="text" class="form-control"
                  id="nameEdit" placeholder="Profile name" value="">
              </div>
              <div class="col-md-12">
                <label class="labels" for="birthdayEdit">Birthday</label>
                <div class="input-group" id="birthdayEdit">
                  <input type="text" class="form-control" id="monthEdit" placeholder="Month" aria-label="Month">
                  <input type="number" class="form-control" id="dayEdit" placeholder="Day" aria-label="Day">
                  <input type="number" class="form-control" id="yearEdit" placeholder="Year" aria-label="Year">
                </div>
              </div>
              <div class="col-md-12">
                <label class="labels" for="genderEdit">Gender</label>
                <select class="form-control" id="genderEdit" aria-label="gender">
                  <option value="" selected hidden></option>
                  <option value="Male">Male</option>
                  <option value="Female">Female</option>
                  <option value="Other">Other</option>
                </select>
              </div>
            </div>
            <div class="row">
              <div class="col-md-12">
                <label class="labels">Location</label>
                <div class="input-group">
                  <input type="text" class="form-control" id="cityEdit" placeholder="City" aria-label="City">
                  <input type="text" class="form-control" id="stateEdit" placeholder="State" aria-label="State">
                  <select class="form-control" id="countryEdit" aria-label="Country"> 
                    <option value="" selected hidden>Country</option>
                    <option value="CA">Canada</option>
                    <option value="US">United States</option>
                    <option value="AU">Australia</option>
                    <option value="UK">United Kingdom</option>
                    <option value="FR">France</option>
                    <option value="JP">Japan</option>
                    <option value="BR">Brazil</option>
                  </select>
                </div>
                </div>
              <!-- <div class="col-md-12"><label class="labels">Time Zone</label><input type="text" class="form-control"
                  id="timeZoneEdit" placeholder="PST, EST, GMT..." value=""></div> -->
              <div class="col-md-12"><label class="labels">Discord ID</label><input type="text" class="form-control"
                  id="discordIDEdit" placeholder="Discord#1111" value=""></div>
            </div>
            <div class="form-group">
              <label class="labels" for="exampleFormControlTextarea1">About Me</label>
              <textarea class="form-control" id="descriptionEdit" rows="3"></textarea>
          </div>
          </fieldset>
          <br>
          <div class="row">
            <div class="col-sm-12 text-center">
              <button type="button" class="btn btn-info btn-md center-block" onclick="editProfile()">Edit</button>
              <button type="button" class="btn btn-danger btn-md center-block" onclick="saveProfile()">Save</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    var currentUser
    function populateProfile() {
      firebase.auth().onAuthStateChanged(user => {
        // Check if user is signed in:
        if (user) {

          //go to the correct user document by referencing to the user uid
          currentUser = db.collection("users").doc(user.uid)
          //get the document for current user.
          currentUser.get()
            .then(userDoc => {
              //get the data fields of the user
              var userName = userDoc.data().name;
              var userAge = userDoc.data().age;
              var userGender = userDoc.data().gender;
              var userYear = userDoc.data().year;
              var userMonth = userDoc.data().month;
              var userDay = userDoc.data().day;
              var userCountry = userDoc.data().country;
              var userState = userDoc.data().state;
              var userCity = userDoc.data().city;
              // var userTimeZone = userDoc.data().timeZone;
              var userDiscord = userDoc.data().discordID;
              var userAbout = userDoc.data().aboutMe;

              //if the data fields are not empty, then write them in to the form.
              if (userName != null) {
                document.getElementById("nameEdit").value = userName;
              }
              if (userGender != null) {
                document.getElementById("genderEdit").value = userGender;
              }
              if (userYear != null) {
                document.getElementById("yearEdit").value = userYear;
              }
              if (userMonth != null) {
                document.getElementById("monthEdit").value = userMonth;
              }
              if (userDay != null) {
                document.getElementById("dayEdit").value = userDay;
              }
              if (userCountry != null) {
                document.getElementById("countryEdit").value = userCountry;
              }
              if (userState != null) {
                document.getElementById("stateEdit").value = userState;
              }
              if (userCity != null) {
                document.getElementById("cityEdit").value = userCity;
              }
              // if (userTimeZone != null) {
              //   document.getElementById("timeZoneEdit").value = userTimeZone;
              // }
              if (userDiscord != null) {
                document.getElementById("discordIDEdit").value = userDiscord;
              }
              if(userAbout != null) {
                document.getElementById("descriptionEdit").value = userAbout;
              }
            })
        } else {
          // No user is signed in.
          console.log("No user is signed in");
        }
      });
    }

    //call the function to run it 
    populateProfile();

    function editProfile() {
            //Enable the form fields
            document.getElementById('personalInfoFields').disabled = false;
        }

    function saveProfile() {

      userName = document.getElementById('nameEdit').value;       //get the value of the field with id="nameEdit"
      userYear = document.getElementById('yearEdit').value;     //get the value of the field with id="yearEdit"
      userMonth = document.getElementById('monthEdit').value;     //get the value of the field with id="monthEdit"
      userDay = document.getElementById('dayEdit').value;     //get the value of the field with id="dayEdit"
      userGender = document.getElementById('genderEdit').value;       //get the value of the field with id="genderEdit"
      userCountry = document.getElementById('countryEdit').value;       //get the value of the field with id="countryEdit"
      userState = document.getElementById('stateEdit').value;       //get the value of the field with id="stateEdit"
      userCity = document.getElementById('cityEdit').value;       //get the value of the field with id="cityEdit"
      // userTimeZone = document.getElementById('timeZoneEdit').value;       //get the value of the field with id="timeZoneEdit"
      userDiscord = document.getElementById('discordIDEdit').value;       //get the value of the field with id="discordIDEdit"
      userAbout = document.getElementById('descriptionEdit').value;       //get the value of the field with id="descriptionEdit"
      userAge = calculateAge(new Date(userYear, userMonth, userDay));     //get the user's age
      
      if (userYear == "") {
              userAge = "";
      }
      
      currentUser.update({
        name: userName,
        age: userAge,
        gender: userGender,
        country: userCountry,
        state: userState,
        city: userCity,
        year: userYear,
        month: userMonth,
        day: userDay,
        // timeZone: userTimeZone,
        discordID: userDiscord,
        aboutMe: userAbout
      })
        .then(() => {
          console.log("Document successfully updated!");
        })
        document.getElementById('personalInfoFields').disabled = true;
    }

    //direct click to the actual input
    function browseFile() {
      document.getElementById('uploadPic').click();
    }

    function uploadUserProfilePic() {
        // Let's assume my storage is only enabled for authenticated users 
        // This is set in your firebase console storage "rules" tab

        firebase.auth().onAuthStateChanged(function (user) {
            var fileInput = document.getElementById("uploadPic");   // pointer #1
            const image = document.getElementById("profilePic"); // pointer #2

            // listen for file selection
            fileInput.addEventListener('change', function (e) {
                var file = e.target.files[0];
                var blob = URL.createObjectURL(file);
                image.src = blob;            // display this image

                //store using this name
                var storageRef = storage.ref("images/" + user.uid + ".jpg"); 
                
                //upload the picked file
                storageRef.put(file) 
                    .then(function(){
                        console.log('Uploaded to Cloud Storage.');
                    })

                //get the URL of stored file
                storageRef.getDownloadURL()
                    .then(function (url) {   // Get URL of the uploaded file
                        console.log(url);    // Save the URL into users collection
                        db.collection("users").doc(user.uid).update({
                            profilePic: url
                        })
                        .then(function(){
                            console.log('Added Profile Pic URL to Firestore.');
                        })
                    })
            })
        })
    }
    uploadUserProfilePic();

    function displayUserProfilePic() {
      console.log("hi");
      firebase.auth().onAuthStateChanged(function (user) {      //get user object
        db.collection("users").doc(user.uid)                  //use user's uid
            .get()                                            //READ the doc
            .then(function (doc) {
                var picUrl = doc.data().profilePic;           //extract pic url

								// use this line if "mypicdiv" is a "div"
                //$("#mypicdiv").append("<img src='" + picUrl + "'>")
                
								// use this line if "mypic-goes-here" is an "img" 
								$(profilePic).attr("src", picUrl);
            })
      })
    }
    displayUserProfilePic();

    document.getElementById("savePref").addEventListener("click", function() {
        document.getElementById('changePref').click();
        savePreferences();
      });

    function savePreferences() {
        firebase.auth().onAuthStateChanged(user => {
          if (user) {
            currentUser = db.collection("users").doc(user.uid);
            
            let userMOBA = document.getElementById('moba').checked;
            let userBattleRoyale = document.getElementById('battleRoyale').checked;
            let userRTS = document.getElementById('rts').checked;
            let userShooter = document.getElementById('shooter').checked;
            let userMMORPG = document.getElementById('mmorpg').checked;
            let userStory = document.getElementById('story').checked;
            let userPlaystyle = document.getElementById('playstyle').value;
            let userSchedule = $('input[name=schedule]:checked').val();

            if (userSchedule === undefined) {
              userSchedule = null;
            }

            currentUser.update({
              moba: userMOBA,
              battleRoyale: userBattleRoyale,
              rts: userRTS,
              shooter: userShooter,
              mmorpg: userMMORPG,
              story: userStory,
              playstyle: userPlaystyle,
              schedule: userSchedule
            }).then(() => {
              console.log("Document successfully updated!");
            })
          }
        });
      }

      function populatePreferences() {
      firebase.auth().onAuthStateChanged(user => {
        if (user) {

          currentUser = db.collection("users").doc(user.uid)
          currentUser.get()
            .then(userDoc => {
              var userMOBA = userDoc.data().moba;
              var userBattleRoyale = userDoc.data().battleRoyale;
              var userRTS = userDoc.data().rts;
              var userShooter = userDoc.data().shooter;
              var userMMORPG = userDoc.data().mmorpg;
              var userStory = userDoc.data().story;
              var userPlaystyle = userDoc.data().playstyle;
              var userSchedule = userDoc.data().schedule;

              if (userMOBA == true) {
                document.getElementById("moba").checked = true;
              } else {
                document.getElementById("moba").checked = false;
              }
              if (userBattleRoyale == true) {
                document.getElementById("battleRoyale").checked = true;
              } else {
                document.getElementById("battleRoyale").checked = false;
              }
              if (userRTS == true) {
                document.getElementById("rts").checked = true;
              } else {
                document.getElementById("rts").checked = false;
              }
              if (userShooter == true) {
                document.getElementById("shooter").checked = true;
              } else {
                document.getElementById("shooter").checked = false;
              }
              if (userMMORPG == true) {
                document.getElementById("mmorpg").checked = true;
              } else {
                document.getElementById("mmorpg").checked = false;
              }
              if (userStory == true) {
                document.getElementById("story").checked = true;
              } else {
                document.getElementById("story").checked = false;
              }
              if (userPlaystyle != null) {
                document.getElementById("playstyle").value = userPlaystyle;
              }
              if(userSchedule != null) {
                if (userSchedule == 0) {
                    $('#schedule4').prop("checked", true);
                  }
                  if (userSchedule == 1) {
                    $('#schedule1').prop("checked", true);
                  }
                  if (userSchedule == 2) {
                    $('#schedule2').prop("checked", true);
                  }
                  if (userSchedule == 3) {
                    $('#schedule3').prop("checked", true);
                  }
              }
            })
          } else {
            console.log("No user is signed in");
          }
        });
      }

      populatePreferences();

      function calculateAge(birthDate) { 
        var diff_ms = Date.now() - birthDate.getTime();
        var age_dt = new Date(diff_ms); 
  
          return Math.abs(age_dt.getUTCFullYear() - 1970);
      }

  </script>


</body>

</html>